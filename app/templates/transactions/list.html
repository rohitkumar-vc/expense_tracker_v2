{% extends "base.html" %}

{% block title %}Transactions - Expense Manager{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">Transactions</h1>
        <button onclick="document.getElementById('addTxnModal').classList.remove('hidden')"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
            <span class="material-symbols-outlined mr-2">add</span>
            Add Transaction
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-md p-4">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" name="search" value="{{ search }}" placeholder="Search..."
                class="px-3 py-2 border rounded-lg">
            <select name="type" class="px-3 py-2 border rounded-lg">
                <option value="">All Types</option>
                <option value="income" {% if selected_type=='income' %}selected{% endif %}>Income</option>
                <option value="expense" {% if selected_type=='expense' %}selected{% endif %}>Expense</option>
                <option value="transfer" {% if selected_type=='transfer' %}selected{% endif %}>Transfer</option>
            </select>
            <input type="date" name="date_from" value="{{ date_from }}" class="px-3 py-2 border rounded-lg">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Filter</button>
        </form>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y">
                    {% for txn in transactions %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">{{ txn.date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs font-semibold
                                {% if txn.type.value == 'income' %}bg-green-100 text-green-800
                                {% elif txn.type.value == 'expense' %}bg-red-100 text-red-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ txn.type.value.upper() }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">{{ txn.description or 'N/A' }}</td>
                        <td class="px-4 py-3 text-sm">{{ txn.category.name if txn.category else '-' }}</td>
                        <td class="px-4 py-3 text-sm text-right font-semibold
                            {% if txn.type.value == 'income' %}text-green-600
                            {% elif txn.type.value == 'expense' %}text-red-600
                            {% else %}text-blue-600{% endif %}">
                            ${{ "%.2f"|format(txn.amount) }}
                        </td>
                        <td class="px-4 py-3 text-sm text-center">
                            <form method="POST" action="/transactions/{{ txn.id }}/delete" class="inline"
                                onsubmit="return confirm('Delete?');">
                                <button type="submit" class="text-red-600 hover:text-red-800">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Export -->
    <div class="flex gap-4">
        <a href="/export/csv" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
            <span class="material-symbols-outlined mr-2">download</span>
            Export CSV
        </a>
        <a href="/export/excel" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
            <span class="material-symbols-outlined mr-2">download</span>
            Export Excel
        </a>
    </div>
</div>

<!-- Add Transaction Modal -->
<div id="addTxnModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">Add Transaction</h3>
        <form method="POST" action="/transactions/create" enctype="multipart/form-data" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Type *</label>
                <select name="transaction_type" id="txnType" required onchange="toggleTxnFields()"
                    class="w-full px-3 py-2 border rounded-lg">
                    <option value="income">Income</option>
                    <option value="expense">Expense</option>
                    <option value="transfer">Transfer</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Amount *</label>
                <input type="number" name="amount" step="0.01" required class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Date *</label>
                <input type="date" name="transaction_date" required value="{{ now().strftime('%Y-%m-%d') }}"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Description</label>
                <input type="text" name="description" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div id="categoryField">
                <label class="block text-sm font-medium mb-1">Category</label>
                <select name="category_id" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">Select Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }} ({{ cat.type.value }})</option>
                    {% endfor %}
                </select>
            </div>
            <div id="sourceField">
                <label class="block text-sm font-medium mb-1">Source Account</label>
                <select name="source_account_id" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">Select Account</option>
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.type.value }})</option>
                    {% endfor %}
                </select>
            </div>
            <div id="destField" class="hidden">
                <label class="block text-sm font-medium mb-1">Destination Account</label>
                <select name="dest_account_id" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">Select Account</option>
                    {% for acc in accounts %}
                    <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.type.value }})</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Receipt (optional)</label>
                <input type="file" name="receipt" accept="image/*,.pdf" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="flex gap-3">
                <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg">Add</button>
                <button type="button" onclick="document.getElementById('addTxnModal').classList.add('hidden')"
                    class="flex-1 bg-gray-200 px-4 py-2 rounded-lg">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function toggleTxnFields() {
        const type = document.getElementById('txnType').value;
        document.getElementById('destField').classList.toggle('hidden', type !== 'transfer' && type !== 'income');
    }
</script>
{% endblock %}